# Colorado COVID-19 Cases — API-Driven Analysis & Shiny Dashboard

This repository contains:
- A **Quarto analysis** that queries the CDC Socrata API (`data.cdc.gov`, resource `n8mc-b4w4`) using server-side SoQL aggregation.
- A **Shiny dashboard** (`app.R`) that reads aggregated datasets from the local `cache/` folder (generated by the Quarto analysis) and presents interactive charts and tables.

You can run the **dashboard immediately** using the cached `.rds` files committed in `cache/`. You only need a CDC Socrata **App Token** if you want to refresh the data by re-running the Quarto analysis or enable live API calls.

---

## Quick Start (Run the dashboard locally)

### 1) Clone the repo
```bash
git clone https://github.com/ileleiwi/colorado_covid_cases.git
cd colorado_covid_cases
```

### 2) Install required R packages
```bash
R -q -e "install.packages(c('shiny','bslib','DT','dplyr','tidyr','lubridate','ggplot2','scales','purrr','readr'))"
```

> Tip (Windows/PowerShell): replace `R -q -e` with `Rscript -e` if needed.

### 3) Run the app
```bash
R -q -e "shiny::runApp(port=8080, host='127.0.0.1', launch.browser=TRUE)"
```
Then open the printed URL (usually `http://127.0.0.1:8080`) if your browser doesn’t open automatically.

---

## What you’ll see

**Tabs**
- **Overview** — Statewide monthly cases and (if present) hospitalization/death ratios.
- **County Explorer** — Select a month to rank counties; optional focus on one county; export CSV.
- **Tables** — Interactive tables for monthly totals and monthly age distributions.
- **About** — How the cache is produced and how to refresh it.

**Filters**
- Month range, age-group selector, and month picker for county views.

---

## Refresh data (rebuild the `cache/` from the CDC API)

This step is optional. The app works with the committed cache. If you want to **re-pull data** from the API and regenerate the cache, you’ll need a CDC Socrata **App Token**.

### A) Create a CDC token
1. Sign in at **https://data.cdc.gov/**
2. Profile → **My Applications** → **New App Token**
3. Copy the **App Token** (a long alphanumeric string).

### B) Store your token safely (so it’s **not** committed)
Add it to your user `~/.Renviron` (recommended):
```r
# In R:
install.packages('usethis')  # if not installed
usethis::edit_r_environ(scope = 'user')
```
Add this line to the file that opens (no quotes), save, then **restart R**:
```
SOCRATA_APP_TOKEN_CDC=your_long_token_here
```
Verify R can see it:
```r
nchar(Sys.getenv('SOCRATA_APP_TOKEN_CDC'))
# should print a number > 20
```

> Project-scoped alternative: create a file named `.Renviron` in the repo root with the same line and ensure `.Renviron` is in `.gitignore`. You can commit `.Renviron.example` with a placeholder value to guide collaborators.

### C) Install analysis dependencies
```bash
R -q -e "install.packages(c('httr','jsonlite','tibble','glue','dplyr','tidyr','lubridate','ggplot2','sf','tigris','leaflet','purrr','readr'))"
```

### D) Install Quarto (if you want to render the `.qmd`)
- Download from https://quarto.org/ and install (CLI required to render).
- Verify: `quarto --version`

### E) Render the analysis to rebuild caches
```bash
quarto render scripts/analysis.qmd
```
This will populate/update files in `cache/` such as:
- `co_month.rds` — CO monthly totals
- `co_by_age.rds` — monthly counts by age group
- `co_county.rds` — county totals
- `co_county_month_YYYY.rds` — monthly by county, sliced by year
- (optional) `severe.rds` — hospitalization/death ratios by month

Re-launch the Shiny app after the render:
```bash
R -q -e "shiny::runApp(port=8080, host='127.0.0.1', launch.browser=TRUE)"
```

---

## Repository structure (key files)

```
.
├── app.R                         # Shiny dashboard
├── scripts/
│   └── analysis.qmd             # Quarto analysis that builds cache/
├── cache/                        # Aggregated data (RDS) used by the app
│   ├── co_month.rds
│   ├── co_by_age.rds
│   ├── co_county.rds
│   └── co_county_month_YYYY.rds # yearly slices
├── README.md
└── .gitignore
```

---

## Troubleshooting

**The app starts but plots are empty**
- Ensure the `cache/` folder contains `.rds` files. If not, run the Quarto analysis to generate them.

**403 / Invalid app token when rendering the analysis**
- Tokens are **domain-scoped**. Use a token created on **data.cdc.gov**.
- Confirm R can see it: `nchar(Sys.getenv('SOCRATA_APP_TOKEN_CDC'))` prints a number > 20.
- Put the token in `~/.Renviron` (or a git-ignored project `.Renviron`), then **restart R**.

**Timeouts while rendering analysis**
- The analysis uses server-side SoQL with year-sliced queries and retries. If your network is slow, just rerun `quarto render` — it caches slices as `.rds` and resumes quickly.

**Port already in use**
- Change the port, e.g.:
  ```bash
  R -q -e "shiny::runApp(port=8787, host='127.0.0.1', launch.browser=TRUE)"
  ```

**Windows tips**
- Use `Rscript -e` instead of `R -q -e` in the commands above.
- If `quarto` isn’t found, add it to PATH or run from the Quarto Command Prompt.

---

## Data source & ethics

Data are sourced from the **CDC COVID-19 Case Surveillance** public dataset on `data.cdc.gov` (resource ID `n8mc-b4w4`). The dashboard only uses **aggregated** counts (no row-level PII). Follow all applicable data-use terms on the CDC Open Data portal.

---

## License & citation

- Code: MIT 
- If you use this in a report or publication, please cite the CDC dataset and link back to this repository.

---

## One-liners (copy/paste)

**Clone & run:**
```bash
git clone https://github.com/ileleiwi/colorado_covid_cases.git
cd colorado_covid_cases
R -q -e "install.packages(c('shiny','bslib','DT','dplyr','tidyr','lubridate','ggplot2','scales','purrr','readr'))"
R -q -e "shiny::runApp(port=8080, host='127.0.0.1', launch.browser=TRUE)"
```
